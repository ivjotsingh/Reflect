<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReflectAI - Therapy Session</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/breathing-exercise.css">
    <link rel="stylesheet" href="css/cbt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern color palette */
            --primary: #4361ee;
            --primary-hover: #3a56d4;
            --secondary: #7209b7;
            --accent: #4cc9f0;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --success: #38b000;
            --error: #d00000;
            --warning: #ffaa00;
            --info: #00b4d8;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);

            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;

            /* Typography */
            --heading-line-height: 1.2;
            --body-line-height: 1.6;
            --heading-letter-spacing: -0.02em;
            --body-letter-spacing: 0.01em;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;

            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: var(--body-line-height);
            letter-spacing: var(--body-letter-spacing);
            margin: 0;
            padding: 0;
        }

        /* Improved typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            line-height: var(--heading-line-height);
            letter-spacing: var(--heading-letter-spacing);
            font-weight: 600;
            color: var(--text);
            margin-top: 0;
        }

        p {
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        /* Enhanced button styling */
        button,
        .button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        button:hover,
        .button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active,
        .button:active {
            transform: translateY(1px);
        }

        /* Card styling */
        .card {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        /* Improved input styling */
        input,
        textarea,
        select {
            background-color: var(--surface);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            transition: all var(--transition-normal);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.3);
        }

        /* Enhanced chat interface styling */
        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        .chat-header {
            margin-bottom: var(--space-xl);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding-bottom: var(--space-lg);
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .message {
            max-width: 85%;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-lg);
            animation: fadeIn 0.3s ease-out;
            box-shadow: var(--shadow-sm);
            position: relative;
            transition: transform var(--transition-fast);
        }

        .message:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.received {
            align-self: flex-start;
            background-color: rgba(50, 50, 60, 0.9);
            color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border-top-left-radius: 4px;
        }

        .message.received .message-text {
            color: rgba(255, 255, 255, 0.95) !important;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .message.received p,
        .message.received div,
        .message.received span {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-top-right-radius: 4px;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: var(--space-xs);
        }

        /* Input area styling */
        .chat-input-wrapper {
            position: relative;
            background: linear-gradient(to right, rgba(67, 97, 238, 0.05), rgba(124, 58, 237, 0.05));
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-top: 1rem;
        }

        .chat-input-container {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-md) var(--space-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all var(--transition-normal);
            display: flex;
            align-items: flex-end;
        }

        .chat-input-container:focus-within {
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
        }

        #messageInput {
            flex: 1;
            border: none;
            resize: none;
            min-height: 24px;
            max-height: 150px;
            padding: 0;
            background: transparent;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: var(--text);
            line-height: 1.5;
        }

        #messageInput:focus {
            outline: none;
        }

        .send-button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: var(--space-sm);
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .message-input-help {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding: 0 0.5rem;
        }

        /* Enhanced modal styling */
        .modal {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: none;
            padding: 0;
            max-width: 600px;
            width: 100%;
            background: var(--surface);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: var(--space-lg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-top-left-radius: var(--radius-lg);
            border-top-right-radius: var(--radius-lg);
        }

        .modal-title {
            margin: 0;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .modal-content {
            padding: var(--space-lg);
        }

        .modal-footer {
            padding: var(--space-md) var(--space-lg);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-md);
        }

        /* Enhanced tabs and navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: var(--space-lg);
        }

        .tab {
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            position: relative;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color var(--transition-normal);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }

        .tab:hover {
            color: var(--primary);
        }

        /* Modern header and navigation styling */
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            padding: var(--space-md) var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .brand-logo {
            height: 32px;
            margin-right: var(--space-sm);
            transition: transform var(--transition-normal);
        }

        .brand:hover .brand-logo {
            transform: rotate(-5deg);
        }

        .brand-name {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: var(--heading-letter-spacing);
        }

        .nav-links {
            display: flex;
            gap: var(--space-lg);
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 500;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            transition: all var(--transition-normal);
            position: relative;
        }

        .nav-link:hover {
            color: white;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: white;
            transition: width var(--transition-normal);
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active::after {
            width: 100%;
        }

        .user-area {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Fix text visibility issues - make text stand out against background */
        .message-text,
        .ai-message,
        .user-message,
        p,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: var(--text);
            background-color: transparent;
            position: relative;
            z-index: 5;
        }

        /* Message bubbles need contrast with the background */
        .message.received,
        .message.sent {
            background-color: var(--surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-md);
        }

        .message.sent {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        /* Fix chat input container size and styling */
        .message-form-container {
            width: 100%;
            position: relative;
            z-index: 100;
            margin-top: 1rem;
        }

        .message-form {
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
            z-index: 100;
        }

        .chat-input-container {
            display: flex;
            align-items: center;
            background-color: var(--surface);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-lg);
            padding: 10px 15px;
            width: 100%;
            min-height: 50px;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 100;
        }

        #message-input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 16px;
            padding: 10px 0;
            min-height: 20px;
            max-height: 150px;
            overflow-y: auto;
            resize: none;
            font-family: 'Inter', sans-serif;
            width: 100%;
            position: relative;
            z-index: 101;
        }

        .chat-controls {
            display: flex;
            align-items: center;
            margin-left: 10px;
            gap: 8px;
        }

        .chat-control-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            border: none;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        /* Target message-bubble content specifically */
        .message-bubble p,
        .message-bubble div,
        .message-bubble span,
        .message-text,
        .message-time {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Additional specific targeting for received messages */
        .message.received .message-bubble p,
        .message.received .message-bubble span,
        .message.received .message-bubble div {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Enhanced chat input styling */
        .chat-input-container {
            display: flex;
            align-items: center;
            background-color: var(--surface);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-lg);
            padding: 8px 16px;
            box-shadow: var(--shadow-md);
            margin-top: 1rem;
            transition: all var(--transition-normal);
            width: 100%;
        }

        .chat-input-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--text);
            padding: 10px 0;
            min-height: 44px;
            outline: none;
            resize: none;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Improved send button styling */
        .send-button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            border: none;
            transition: all var(--transition-normal);
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* Target specific elements inside message bubble */
        .message-bubble p {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            margin: 0 0 8px 0;
            font-weight: 500;
        }

        /* Fix for message paragraphs in received messages */
        .message.received .message-bubble p {
            color: rgba(255, 255, 255, 0.95) !important;
            font-weight: 500;
        }

        /* Improved sidebar text visibility */
        .sidebar h3,
        .sidebar-section h3,
        .sidebar p,
        .sidebar span,
        .feature-item-text,
        .sidebar-label {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Ensure all headings are visible */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        /* Fix text visibility in dark areas */
        .feature-item,
        .mood-options,
        .mood-option,
        .sidebar-section {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* RAG Section Styles */
        .rag-showcase {
            margin-top: var(--space-lg);
        }

        .rag-info-container {
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-top: var(--space-md);
        }

        .rag-description {
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Timer styles */
        .timer-options {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            flex-wrap: wrap;
        }

        .timer-option {
            flex: 1;
            min-width: 70px;
            text-align: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--text);
            font-weight: 500;
        }

        .timer-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .timer-option.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 201, 240, 0.3);
        }

        .timer-display-container {
            margin: var(--space-lg) auto;
            width: 200px;
            height: 200px;
            position: relative;
        }

        .timer-display {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .timer-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--accent) 0%, transparent 0%);
            transition: background 0.3s ease;
            transform: rotate(-90deg);
        }

        .timer-center {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            background: var(--background);
            border-radius: 50%;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .timer-time {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .timer-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .timer-markers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
        }

        .timer-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            margin-left: -2px;
            margin-top: -2px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform-origin: center;
        }

        .timer-marker:nth-child(3n) {
            width: 6px;
            height: 6px;
            margin-left: -3px;
            margin-top: -3px;
            background: rgba(255, 255, 255, 0.5);
        }

        .timer-controls {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            justify-content: center;
        }

        .timer-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-sm) var(--space-lg);
            background: var(--surface);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            font-weight: 500;
            gap: var(--space-sm);
        }

        .timer-btn.primary {
            background: var(--accent);
            color: white;
        }

        .timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .timer-btn:active {
            transform: translateY(0);
        }

        .timer-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Mood tracking styles */
        .mood-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .mood-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
            border-radius: var(--radius-md);
            background-color: var(--surface);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-normal);
            padding: 8px;
        }

        .mood-option:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .mood-option.active {
            background-color: rgba(67, 97, 238, 0.1);
            border: 2px solid var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .mood-emoji {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .mood-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }

        .mood-history-container {
            margin-top: 20px;
        }

        .mood-history {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .mood-day {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .mood-day-emoji {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .mood-day-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
    </style>
    <style>
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.7);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 20px 10px rgba(76, 201, 240, 0.3);
                transform: scale(1.02);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 201, 240, 0);
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <svg class="brand-logo" width="36" height="36" viewBox="0 0 100 100" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M50 0C22.4 0 0 22.4 0 50C0 77.6 22.4 100 50 100C77.6 100 100 77.6 100 50C100 22.4 77.6 0 50 0ZM50 90C27.9 90 10 72.1 10 50C10 27.9 27.9 10 50 10C72.1 10 90 27.9 90 50C90 72.1 72.1 90 50 90Z"
                    fill="white" />
                <path
                    d="M65 35C65 43.3 58.3 50 50 50C41.7 50 35 43.3 35 35C35 26.7 41.7 20 50 20C58.3 20 65 26.7 65 35Z"
                    fill="white" />
                <path
                    d="M35 65C35 56.7 41.7 50 50 50C58.3 50 65 56.7 65 65C65 73.3 58.3 80 50 80C41.7 80 35 73.3 35 65Z"
                    fill="white" />
            </svg>
            <div class="brand-name">ReflectAI</div>
        </div>

        <nav class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="chat.html" class="nav-link active">Chat</a>
            <a href="simulator.html" class="nav-link">Life Simulator</a>
            <a href="call.html" class="nav-link">Voice Call</a>
        </nav>

        <div class="user-area">
            <div class="user-avatar">U</div>
        </div>
    </header>

    <div class="main-container">
        <div class="chat-container">
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Features</h3>
                    <div class="features-list">
                        <div class="feature-item active">
                            <div class="feature-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 90C27.9 90 10 72.1 10 50C10 27.9 27.9 10 50 10C72.1 10 90 27.9 90 50C90 72.1 72.1 90 50 90Z"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                            <span>AI Chat Therapist</span>
                        </div>
                        <div class="feature-item" id="de-stress-button">
                            <div class="feature-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                </svg>
                            </div>
                            <span>De-Stress</span>
                        </div>
                        <div class="feature-item" id="cbt-button">
                            <div class="feature-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M21 11.5C21.0034 12.8199 20.6951 14.1219 20.1 15.3C19.3944 16.7118 18.3098 17.8992 16.9674 18.7293C15.6251 19.5594 14.0782 19.9994 12.5 20C11.1801 20.0035 9.87812 19.6951 8.7 19.1L3 21L4.9 15.3C4.30493 14.1219 3.99656 12.8199 4 11.5C4.00061 9.92179 4.44061 8.37488 5.27072 7.03258C6.10083 5.69028 7.28825 4.6056 8.7 3.90003C9.87812 3.30496 11.1801 2.99659 12.5 3.00003H13C15.0843 3.11502 17.053 3.99479 18.5291 5.47089C20.0052 6.94699 20.885 8.91568 21 11V11.5Z"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M12 12V12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M8 12V12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M16 12V12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                            <span>CBT Tools</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>How are you feeling today?</h3>
                    <div class="mood-options">
                        <div class="mood-option" data-mood="Great">
                            <div class="mood-emoji">😊</div>
                            <div class="mood-label">Great</div>
                        </div>
                        <div class="mood-option" data-mood="Good">
                            <div class="mood-emoji">😀</div>
                            <div class="mood-label">Good</div>
                        </div>
                        <div class="mood-option" data-mood="Okay">
                            <div class="mood-emoji">😐</div>
                            <div class="mood-label">Okay</div>
                        </div>
                        <div class="mood-option" data-mood="Down">
                            <div class="mood-emoji">😔</div>
                            <div class="mood-label">Down</div>
                        </div>
                        <div class="mood-option" data-mood="Stressed">
                            <div class="mood-emoji">😓</div>
                            <div class="mood-label">Stressed</div>
                        </div>
                        <div class="mood-option" data-mood="Angry">
                            <div class="mood-emoji">😠</div>
                            <div class="mood-label">Angry</div>
                        </div>
                    </div>
                    <div class="mood-history-container" id="mood-history-container" style="display: none;">
                        <h4>Your Mood History</h4>
                        <div class="mood-history" id="mood-history">
                            <!-- Mood history will be dynamically populated -->
                        </div>
                    </div>
                </div>
                <!-- RAG Technology Showcase Section -->
                <div class="sidebar-section rag-showcase">
                    <h3>LLM + RAG = Better AI</h3>
                    <div class="rag-info-container">
                        <p class="rag-description">Our AI therapist uses Retrieval-Augmented Generation (RAG) along with
                            LLM to respond with accurate mental health information.</p>
                    </div>
                </div>
            </div>
            <div class="chat-area">
                <!-- Chat Messages -->
                <div id="chat-messages" class="messages-container"></div>

                <!-- Message Input -->
                <div class="chat-input-wrapper">
                    <form id="message-form" class="message-form">
                        <div class="chat-input-container">
                            <textarea id="message-input" class="message-input" placeholder="Type a message..."
                                rows="1"></textarea>
                            <button type="submit" class="send-button">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="loader" class="loader">
        <span>Thinking</span>
        <div class="loader-dots">
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
        </div>
    </div>

    <!-- Breathing Exercise Modal -->
    <div id="breathing-exercise-modal" class="modal-overlay">
        <div class="breathing-modal">
            <div class="modal-header">
                <h2>Guided Breathing Exercise</h2>
                <button id="close-breathing-modal" class="close-modal-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-content">
                <!-- Technique Selection View -->
                <div id="breathing-selection" class="breathing-selection">
                    <div class="breathing-description">
                        <p>Select a scientifically-proven breathing technique to begin your guided exercise. These
                            mindful practices can help reduce stress, anxiety, and promote a sense of calm and balance.
                        </p>
                    </div>

                    <h3>Choose Your Technique</h3>
                    <div class="breathing-patterns">
                        <!-- 4-7-8 Breathing - Dr. Andrew Weil's technique -->
                        <div class="breathing-pattern-card" data-pattern="478">
                            <div class="technique-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"
                                    fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                </svg>
                            </div>
                            <h4>4-7-8 Breathing Technique</h4>
                            <p>Inhale (4s) → Hold (7s) → Exhale (8s)</p>
                            <span class="pattern-description">Developed by Dr. Andrew Weil for stress reduction</span>
                        </div>

                        <!-- Coherent Breathing - clinically proven -->
                        <div class="breathing-pattern-card" data-pattern="coherent">
                            <div class="technique-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"
                                    fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M8 12h8"></path>
                                    <path d="M12 8v8"></path>
                                </svg>
                            </div>
                            <h4>Coherent Breathing</h4>
                            <p>Inhale (5.5s) → Exhale (5.5s)</p>
                            <span class="pattern-description">Researched at Harvard Medical School for autonomic
                                balance</span>
                        </div>

                        <!-- Diaphragmatic Breathing - physiological research backed -->
                        <div class="breathing-pattern-card" data-pattern="diaphragmatic">
                            <div class="technique-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"
                                    fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M7 10l5 5 5-5"></path>
                                </svg>
                            </div>
                            <h4>Diaphragmatic Breathing</h4>
                            <p>Deep Inhale (4s) → Hold (1s) → Slow Exhale (6s)</p>
                            <span class="pattern-description">Recommended by Mayo Clinic to activate parasympathetic
                                system</span>
                        </div>
                    </div>
                </div>

                <!-- Interactive Exercise View -->
                <div id="breathing-exercise-container" class="breathing-exercise-container">
                    <div class="exercise-header">
                        <div>
                            <h3 class="exercise-title" id="technique-title">4-7-8 Breathing Technique</h3>
                            <p class="exercise-subtitle" id="technique-subtitle">Developed by Dr. Andrew Weil for stress
                                reduction</p>
                        </div>
                        <button class="back-to-selection">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                            Back to techniques
                        </button>
                    </div>

                    <div class="breathing-visualization">
                        <div class="breathing-circle-wrapper">
                            <div class="circle-border"></div>
                            <div class="breathing-circle">
                                <div class="wave-container">
                                    <div class="wave"></div>
                                </div>
                                <div class="breathing-animation"></div>
                                <div class="breathing-animation-shadow"></div>
                            </div>

                            <div class="breathing-instruction">
                                <div class="breathing-action" id="breathing-action">Prepare...</div>
                                <div class="breathing-counter" id="breathing-counter">3</div>
                            </div>
                        </div>

                        <div class="breathing-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-stats">
                                <span id="current-cycle">Cycle 0/5</span>
                                <span id="timer">00:00</span>
                            </div>
                        </div>

                        <div class="breathing-controls">
                            <button id="start-breathing" class="breathing-control-btn start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                Begin Exercise
                            </button>
                            <button id="pause-breathing" class="breathing-control-btn pause" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="6" y="4" width="4" height="16"></rect>
                                    <rect x="14" y="4" width="4" height="16"></rect>
                                </svg>
                                Pause
                            </button>
                            <button id="resume-breathing" class="breathing-control-btn resume" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                Resume
                            </button>
                            <button id="stop-breathing" class="breathing-control-btn stop" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                </svg>
                                End Early
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Completion View -->
                <div id="breathing-complete" class="breathing-complete">
                    <div class="complete-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none"
                            stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h3>Exercise Complete</h3>
                    <p>Great job! You've completed your mindful breathing session. Taking these moments for yourself
                        helps build resilience and calm throughout your day.</p>
                    <button id="complete-close" class="breathing-control-btn">
                        Close
                    </button>
                    <button id="restart-breathing" class="breathing-control-btn restart">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 2v6h6"></path>
                            <path d="M21 22v-6h-6"></path>
                            <path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path>
                        </svg>
                        Try Another Technique
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CBT Modal -->
    <div id="cbt-modal" class="cbt-modal-overlay">
        <div class="cbt-modal">
            <div class="cbt-modal-header modal-header">
                <h2>Cognitive Behavioral Therapy Tools</h2>
                <button id="close-cbt-modal" class="close-modal-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="cbt-content">
                <!-- Worksheet Selection Screen -->
                <div id="worksheet-selection" class="worksheet-selection">
                    <div class="cbt-reminder">
                        <h4>CBT Worksheet Selection</h4>
                        <p>Choose one of these evidence-based Cognitive Behavioral Therapy Tools techniques to help
                            manage
                            your thoughts, behaviors, and worries:</p>
                    </div>

                    <div class="worksheet-option" data-worksheet="thought-record">
                        <h3><span class="icon-thought-record"></span>Thought Record</h3>
                        <p>Challenge and reframe negative thoughts by examining the evidence. This technique helps you
                            identify cognitive distortions and develop more balanced perspectives, reducing anxiety and
                            depression.</p>
                        <button class="start-btn">Start Worksheet</button>
                    </div>

                    <div class="worksheet-option" data-worksheet="worry-time">
                        <h3><span class="icon-worry-time"></span>Worry Time</h3>
                        <p>Set aside dedicated time to address worries, preventing them from interfering with your daily
                            life. This technique helps reduce anxiety by containing worry to specific periods.</p>
                        <button class="start-btn">Start Worksheet</button>
                    </div>
                </div>

                <!-- Thought Record Section -->
                <div id="thought-record-section" class="cbt-section">
                    <button class="back-to-selection">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Back to Worksheets
                    </button>

                    <div class="cbt-reminder">
                        <h4>About Thought Records</h4>
                        <p>Thought records help you identify and challenge negative thinking patterns. By examining the
                            evidence for and against your thoughts, you can develop more balanced perspectives.</p>
                    </div>

                    <div class="thought-record-form">
                        <h3>Create a New Thought Record</h3>
                        <div class="form-group">
                            <label for="situation">What happened?</label>
                            <textarea id="situation"
                                placeholder="Describe the specific situation that triggered your thoughts..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="automatic-thought">What went through your mind?</label>
                            <textarea id="automatic-thought"
                                placeholder="What negative thoughts or beliefs came up for you?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="emotions">How did you feel?</label>
                            <textarea id="emotions"
                                placeholder="What emotions did you experience? How intense were they (0-100%)?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="evidence-for">Why might this thought be true?</label>
                            <textarea id="evidence-for"
                                placeholder="What facts or experiences support this thought?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="evidence-against">Why might this thought not be true?</label>
                            <textarea id="evidence-against"
                                placeholder="What facts or experiences suggest this thought might not be accurate?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="balanced-thought">More helpful perspective</label>
                            <textarea id="balanced-thought"
                                placeholder="What's a more realistic or helpful way to think about the situation?"></textarea>
                        </div>
                        <button id="save-thought-record" class="cbt-btn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Save Thought Record
                        </button>
                    </div>

                    <div class="thought-records-list">
                        <h3>Your Thought Records</h3>
                        <div id="thought-records-container">
                            <!-- Thought records will be populated here -->
                            <div class="empty-state">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="9" y1="3" x2="9" y2="21"></line>
                                </svg>
                                <p>You haven't created any thought records yet</p>
                                <button class="cbt-btn">Create Your First Record</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Worry Time Section -->
                <div id="worry-time-section" class="cbt-section">
                    <button class="back-to-selection">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Back to Worksheets
                    </button>

                    <div class="cbt-reminder">
                        <h4>About Worry Time</h4>
                        <p>Worry Time is a technique where you set aside a specific time to address worries, rather
                            than letting them interfere with your daily life. This helps reduce anxiety by containing
                            worry
                            to specific periods.</p>
                    </div>

                    <div class="worry-form">
                        <h3>Schedule Your Daily Worry Time</h3>

                        <div class="timer-options">
                            <div class="timer-option" data-duration="15">15 mins</div>
                            <div class="timer-option" data-duration="30">30 mins</div>
                            <div class="timer-option" data-duration="45">45 mins</div>
                            <div class="timer-option" data-duration="60">60 mins</div>
                        </div>

                        <div class="timer-display-container">
                            <div class="timer-display">
                                <div class="timer-progress"></div>
                                <div class="timer-center">
                                    <div class="timer-time">00:00</div>
                                    <div class="timer-label">Select duration</div>
                                </div>
                                <div class="timer-markers">
                                    <!-- Markers will be added via JavaScript -->
                                </div>
                            </div>
                        </div>

                        <div class="timer-controls">
                            <button id="start-worry-timer" class="timer-btn primary">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                Start Timer
                            </button>
                            <button id="stop-worry-timer" class="timer-btn" style="display: none;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="6" y="4" width="4" height="16"></rect>
                                    <rect x="14" y="4" width="4" height="16"></rect>
                                </svg>
                                Stop & Save
                            </button>
                        </div>
                    </div>
                    <br>
                    <div class="worry-container">
                        <div class="worry-list-container">
                            <h3>Worry List</h3>
                            <div class="form-group">
                                <textarea id="new-worry"
                                    placeholder="Write down a worry to address during your worry time..."></textarea>
                                <button id="add-worry" class="cbt-btn">Add Worry</button>
                            </div>
                            <div id="worries-container" class="worry-list">
                                <!-- Worries will be populated here -->
                            </div>
                        </div>

                        <div class="solution-list-container">
                            <h3>Solutions & Action Plans</h3>
                            <div class="form-group">
                                <textarea id="new-solution"
                                    placeholder="Write down a potential solution or action step..."></textarea>
                                <button id="add-solution" class="cbt-btn">Add Solution</button>
                            </div>
                            <div id="solutions-container" class="solution-list">
                                <!-- Solutions will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBlOKcjfXEiMJuR2wdIHrjBzcFgkrCk4TQ",
            authDomain: "dev-berlin-ivjot.firebaseapp.com",
            projectId: "dev-berlin-ivjot",
            storageBucket: "dev-berlin-ivjot.firebasestorage.app",
            messagingSenderId: "105421402396",
            appId: "1:105421402396:web:a18924ff258193aed40ad9"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOM Elements
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const loader = document.getElementById('loader');
        const moodOptions = document.querySelectorAll('.mood-option');
        const featureItems = document.querySelectorAll('.feature-item');

        // Configuration
        const CONFIG = {
            api: {
                baseUrl: 'http://127.0.0.1:8080/reflect/api/chat',
                endpoints: {
                    postMessage: '/v1/message'
                },
                postMessageFullEndpoint() {
                    return this.baseUrl + this.endpoints.postMessage;
                }
            },
            ui: {
                themeStorageKey: 'reflectai-theme'
            },
            apiEndpoints: {
                chat: "http://127.0.0.1:8080/reflect/api/chat/v1/chat",
                sendMessage: "http://127.0.0.1:8080/reflect/api/chat/v1/message",
                mood: {
                    save: "http://127.0.0.1:8080/reflect/api/mood/v1/mood",
                    history: "http://127.0.0.1:8080/reflect/api/mood/v1/mood/history"
                }
            }
        };

        // Helper function to ensure consistent userId retrieval throughout the app
        function getConsistentUserId() {
            // Try all possible localStorage keys that might contain the userId
            let userId = localStorage.getItem('reflectai-userid')

            console.log('Retrieved userId from localStorage:', userId);
            return userId;
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Firebase
                firebase.initializeApp(CONFIG.firebase);
                const db = firebase.firestore();

                // DOM Elements
                const messageForm = document.getElementById('message-form');
                const messageInput = document.getElementById('message-input');
                const chatMessages = document.getElementById('chat-messages');
                const logoutBtn = document.getElementById('logout-btn');

                // Show loader
                loader.classList.add('active');

                // Get user ID from local storage or create a new one
                const userId = getConsistentUserId();

                console.log('Initializing application for user:', userId);

                // Setup chat functionality
                setupChatFunctionality(userId);

                // Initialize message input functionality
                initializeMessageInput();

                // Initialize mood tracker with a slight delay to ensure all DOM elements are ready
                console.log('Will initialize mood tracker for user:', userId);

                // Get a consistent userId for mood tracking
                const moodTrackerId = getConsistentUserId();
                console.log('Using consistent userId for mood tracking:', moodTrackerId);

                // Run the initial mood history fetch directly
                console.log('Immediately fetching mood history');
                fetchMoodHistory(moodTrackerId);

                // Also initialize with a delay to ensure DOM is fully loaded
                setTimeout(() => {
                    console.log('Now initializing mood tracker after delay for user:', moodTrackerId);
                    initMoodTracker(moodTrackerId);

                    // Also directly call fetchMoodHistory to ensure it runs
                    console.log('Directly calling fetchMoodHistory for user:', moodTrackerId);
                    fetchMoodHistory(moodTrackerId);
                }, 1500);
            } catch (error) {
                console.error('Error initializing application:', error);
                addSystemMessage('Error initializing application. Please refresh the page.');
            }
        });

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize with saved mood if available
            const savedMood = localStorage.getItem('reflectAI_mood');
            if (savedMood) {
                document.querySelector(`.mood-option[data-mood="${savedMood}"]`)?.classList.add('selected');
            } else {
                // Default to neutral mood
                document.querySelector('.mood-option[data-mood="neutral"]')?.classList.add('selected');
            }

            // Mood selection
            moodOptions.forEach(option => {
                option.addEventListener('click', () => {
                    moodOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    const mood = option.getAttribute('data-mood');
                    const userId = getConsistentUserId();
                    if (userId) {
                        saveMood(userId, mood);
                    } else {
                        console.error('No userId found in localStorage for mood saving');
                    }
                });
            });

            const lifeSimulatorButton = document.getElementById('life-simulator-button');
            lifeSimulatorButton.addEventListener('click', () => {
                window.location.href = 'simulator.html';
            });
        });

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function () {
            const userId = getConsistentUserId();

            if (!userId) {
                window.location.href = 'index.html';
                return;
            }

            setupChatFunctionality(userId);
        });

        // Set up chat functionality
        function setupChatFunctionality(userId) {
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const chatMessages = document.getElementById('chat-messages');
            const loader = document.getElementById('loader');
            const logoutBtn = document.getElementById('logout-btn');

            // Set up Firestore real-time listener
            setupChatListener(userId);

            // Auto-adjust textarea height
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Add event listener for Enter key to send message
            messageInput.addEventListener('keydown', function (e) {
                // Check if Enter key is pressed without Shift key
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default newline behavior
                    messageForm.dispatchEvent(new Event('submit')); // Simulate form submission
                }
            });

            // Handle message submission
            messageForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const message = messageInput.value.trim();
                if (!message) return;

                // Add user message to UI
                addMessageToUI('user', message);

                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';

                // Show loader and typing indicator
                loader.classList.add('active');
                showTypingIndicator();

                try {
                    // Send message to API
                    const response = await sendMessage(userId, message);

                    // Check for successful response
                    if (response.status === 'success') {
                        // API call is successful, the Firestore listener will handle the response
                        // But we keep this setTimeout for backward compatibility
                        setTimeout(() => {
                            loader.classList.remove('active');
                            removeTypingIndicator();
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    loader.classList.remove('active');
                    removeTypingIndicator();

                    // Show error message
                    addSystemMessage('Sorry, I encountered an error. Please try again.');
                }
            });

            // Focus on input field when page loads
            messageInput.focus();
        }

        // Add system message to UI
        function addSystemMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = `<p>${message}</p>`;

            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const indicatorDiv = document.createElement('div');
            indicatorDiv.id = 'typing-indicator';
            indicatorDiv.className = 'message ai-message typing-indicator';
            indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(indicatorDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Set up real-time listener for chat messages
        function setupChatListener(userId) {
            // Clear any existing listener
            if (unsubscribeListener) {
                unsubscribeListener();
            }

            // Set up listener on the messages collection for this user/session
            // Using correct collection path from configuration
            const messagesRef = db
                .collection('ChatSessions')
                .doc(userId)
                .collection('ChatMessages')
                .orderBy('timestamp');

            // Create the listener
            unsubscribeListener = messagesRef.onSnapshot((snapshot) => {
                // Clear chat messages except system message
                const chatMessages = document.getElementById('chat-messages');
                const systemMessage = chatMessages.querySelector('.system-message');
                chatMessages.innerHTML = '';

                if (systemMessage) {
                    chatMessages.appendChild(systemMessage);
                }

                // Remove typing indicator when new message received
                removeTypingIndicator();

                // Process all documents in the collection
                snapshot.docs.forEach((doc) => {
                    const message = doc.data();
                    addMessageToUI(
                        message.role === 'user' ? 'user' : 'assistant',
                        message.message,
                        new Date(message.timestamp ? message.timestamp.toDate() : new Date())
                    );
                });

                // Hide loader
                document.getElementById('loader').classList.remove('active');

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, (error) => {
                console.error("Error listening to messages:", error);
                document.getElementById('loader').classList.remove('active');
                addSystemMessage('Error loading messages. Please refresh the page.');
            });
        }

        // Add message to UI
        function addMessageToUI(role, content, timestamp = new Date()) {
            const chatMessages = document.getElementById('chat-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role === 'user' ? 'user' : 'assistant'}`;

            // Add avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';

            // Set appropriate avatar content based on role
            if (role === 'user') {
                avatarDiv.textContent = 'U';
            } else {
                // AI avatar uses the logo
                const aiSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                aiSvg.setAttribute("width", "20");
                aiSvg.setAttribute("height", "20");
                aiSvg.setAttribute("viewBox", "0 0 24 24");
                aiSvg.setAttribute("fill", "none");

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", "M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z");
                path.setAttribute("stroke", "white");
                path.setAttribute("stroke-width", "2");

                aiSvg.appendChild(path);
                avatarDiv.appendChild(aiSvg);
            }

            messageDiv.appendChild(avatarDiv);

            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble';

            // Format message content (handle newlines)
            const formattedContent = content.replace(/\n/g, '<br>');
            messageBubble.innerHTML = `<p>${formattedContent}</p>`;

            messageDiv.appendChild(messageBubble);

            // Add timestamp
            const now = timestamp;
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const timeSpan = document.createElement('div');
            timeSpan.className = 'message-time';
            timeSpan.textContent = timeString;
            messageBubble.appendChild(timeSpan);

            chatMessages.appendChild(messageDiv);

            // Scroll to the bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Fetch messages from API - Kept for backward compatibility
        async function fetchMessages(userId) {
            // This function is kept for backwards compatibility
            // but now the messages are fetched via Firestore listener

            // If we need to fetch messages from API, this would be the correct endpoint
            // const response = await fetch(`${CONFIG.api.getFullEndpoint()}?userId=${userId}`);

            document.getElementById('loader').classList.remove('active');
        }

        // Send message to API
        async function sendMessage(userId, message) {
            const response = await fetch(CONFIG.api.postMessageFullEndpoint(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId,
                    message: message
                })
            });

            return await response.json();
        }
        // Variable to store unsubscribe function
        let unsubscribeListener = null;
    </script>

    <script>
        // Breathing Exercise Modal Functionality
        document.addEventListener('DOMContentLoaded', function () {
            const deStressButton = document.getElementById('de-stress-button');
            const breathingModal = document.getElementById('breathing-exercise-modal');
            const closeModal = document.getElementById('close-breathing-modal');
            const completeClose = document.getElementById('complete-close');

            // Selection and exercise container elements
            const selectionView = document.getElementById('breathing-selection');
            const exerciseContainer = document.getElementById('breathing-exercise-container');
            const completeView = document.getElementById('breathing-complete');
            const patternCards = document.querySelectorAll('.breathing-pattern-card');
            const backToSelection = document.querySelector('.back-to-selection');

            // Exercise control elements
            const startButton = document.getElementById('start-breathing');
            const pauseButton = document.getElementById('pause-breathing');
            const resumeButton = document.getElementById('resume-breathing');
            const stopButton = document.getElementById('stop-breathing');
            const restartButton = document.getElementById('restart-breathing');

            // Display elements
            const techniqueTitle = document.getElementById('technique-title');
            const techniqueSubtitle = document.getElementById('technique-subtitle');
            const breathingAction = document.getElementById('breathing-action');
            const breathingCounter = document.getElementById('breathing-counter');
            const progressFill = document.getElementById('progress-fill');
            const currentCycleDisplay = document.getElementById('current-cycle');
            const timerDisplay = document.getElementById('timer');

            // Animation elements
            const breathingCircle = document.querySelector('.breathing-circle');
            const breathingAnimation = document.querySelector('.breathing-animation');
            const breathingAnimationShadow = document.querySelector('.breathing-animation-shadow');
            const wave = document.querySelector('.wave');

            // Breathing patterns
            const patterns = {
                '478': {
                    title: '4-7-8 Breathing Technique',
                    subtitle: 'Developed by Dr. Andrew Weil for stress reduction',
                    inhale: 4,
                    hold: 7,
                    exhale: 8,
                    cycles: 5
                },
                'coherent': {
                    title: 'Coherent Breathing',
                    subtitle: 'Researched at Harvard Medical School for autonomic balance',
                    inhale: 5.5,
                    hold: 0,
                    exhale: 5.5,
                    cycles: 6
                },
                'diaphragmatic': {
                    title: 'Diaphragmatic Breathing',
                    subtitle: 'Recommended by Mayo Clinic to activate parasympathetic system',
                    inhale: 4,
                    hold: 1,
                    exhale: 6,
                    cycles: 8
                }
            };

            // Exercise state
            let currentPattern = null;
            let currentCycle = 0;
            let currentPhase = null; // 'inhale', 'hold', 'exhale'
            let exerciseActive = false;
            let exercisePaused = false;
            let intervalId = null;
            let countdownId = null;
            let startTime = null;
            let elapsedPausedTime = 0;
            let totalDuration = 0;

            // Open modal
            deStressButton.addEventListener('click', () => {
                breathingModal.style.display = 'flex';
                resetExerciseState();
            });

            // Close modal buttons
            closeModal.addEventListener('click', closeBreathingModal);
            completeClose.addEventListener('click', closeBreathingModal);

            function closeBreathingModal() {
                breathingModal.style.display = 'none';
                resetExerciseState();
            }

            // Select breathing pattern
            patternCards.forEach(card => {
                card.addEventListener('click', () => {
                    const patternKey = card.getAttribute('data-pattern');
                    selectPattern(patternKey);
                });
            });

            // Back to selection
            backToSelection.addEventListener('click', () => {
                resetExerciseState();
                showSelectionView();
            });

            // Start exercise
            startButton.addEventListener('click', startExercise);

            // Pause exercise
            pauseButton.addEventListener('click', pauseExercise);

            // Resume exercise
            resumeButton.addEventListener('click', resumeExercise);

            // Stop exercise
            stopButton.addEventListener('click', () => {
                stopExercise();
                showSelectionView();
            });

            // Restart with another technique
            restartButton.addEventListener('click', () => {
                resetExerciseState();
                showSelectionView();
            });

            function selectPattern(patternKey) {
                currentPattern = patterns[patternKey];
                techniqueTitle.textContent = currentPattern.title;
                techniqueSubtitle.textContent = currentPattern.subtitle;

                showExerciseView();
            }

            function showSelectionView() {
                selectionView.style.display = 'block';
                exerciseContainer.style.display = 'none';
                completeView.style.display = 'none';
            }

            function showExerciseView() {
                selectionView.style.display = 'none';
                exerciseContainer.style.display = 'block';
                completeView.style.display = 'none';
            }

            function showCompleteView() {
                selectionView.style.display = 'none';
                exerciseContainer.style.display = 'none';
                completeView.style.display = 'block';
            }

            function startExercise() {
                if (exerciseActive) return;

                startButton.style.display = 'none';
                pauseButton.style.display = 'flex';
                stopButton.style.display = 'flex';

                exerciseActive = true;
                startTime = Date.now();
                totalDuration = calculateTotalDuration();

                // Start with 3 second countdown
                let countdown = 3;
                breathingAction.textContent = 'Prepare...';
                breathingCounter.textContent = countdown;

                countdownId = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        breathingCounter.textContent = countdown;
                    } else {
                        clearInterval(countdownId);
                        startBreathingCycle();
                    }
                }, 1000);

                // Start timer
                updateTimer();
            }

            function pauseExercise() {
                if (!exerciseActive || exercisePaused) return;

                exercisePaused = true;
                pauseButton.style.display = 'none';
                resumeButton.style.display = 'flex';

                // Stop animations
                clearInterval(intervalId);

                // Pause wave and circle at current state
                wave.style.transition = 'none';
                breathingCircle.style.transition = 'none';
                breathingAnimation.style.transition = 'none';
                breathingAnimationShadow.style.transition = 'none';

                breathingAction.textContent = 'Paused';
                breathingCounter.style.display = 'none';
            }

            function resumeExercise() {
                if (!exerciseActive || !exercisePaused) return;

                exercisePaused = false;
                resumeButton.style.display = 'none';
                pauseButton.style.display = 'flex';

                // Add the paused time
                elapsedPausedTime += (Date.now() - (startTime + elapsedPausedTime));

                // Resume animations from where they left off
                breathingCounter.style.display = 'block';

                // Restore transitions
                wave.style.transition = 'transform 0.5s ease-in-out';
                breathingCircle.style.transition = 'transform 0.5s ease-in-out';
                breathingAnimation.style.transition = 'transform 0.5s ease-in-out';
                breathingAnimationShadow.style.transition = 'transform 0.5s ease-in-out';

                // Continue from current phase
                continueBreathingCycle();
            }

            function stopExercise() {
                if (!exerciseActive) return;

                // Reset UI
                exerciseActive = false;
                exercisePaused = false;

                clearInterval(intervalId);
                clearInterval(countdownId);

                startButton.style.display = 'flex';
                pauseButton.style.display = 'none';
                resumeButton.style.display = 'none';
                stopButton.style.display = 'none';

                resetAnimations();
            }

            function startBreathingCycle() {
                currentCycle = 1;
                updateCurrentCycleDisplay();
                startInhalePhase();
            }

            function continueBreathingCycle() {
                // Pick up from where we left off
                if (currentPhase === 'inhale') {
                    startInhalePhase();
                } else if (currentPhase === 'hold') {
                    startHoldPhase();
                } else if (currentPhase === 'exhale') {
                    startExhalePhase();
                }
            }

            function startInhalePhase() {
                if (!exerciseActive || exercisePaused) return;

                currentPhase = 'inhale';
                const duration = currentPattern.inhale;

                // Update UI
                breathingAction.textContent = 'Inhale';
                updateCountdown(duration);

                // Animation
                breathingCircle.style.transform = 'scale(1.2)';
                breathingAnimation.style.transform = 'scale(1.3)';
                breathingAnimationShadow.style.transform = 'scale(1.35)';

                // Add inhale class and remove other classes
                breathingCircle.classList.remove('exhale', 'hold');

                // Set animation duration dynamically based on the inhale duration
                wave.style.animationDuration = `${duration}s`;
                wave.style.animationFillMode = 'forwards';

                // Apply the inhale class after setting the animation duration
                breathingCircle.classList.add('inhale');

                // When inhale is done, move to hold or exhale
                setTimeout(() => {
                    if (!exerciseActive || exercisePaused) return;

                    if (currentPattern.hold > 0) {
                        startHoldPhase();
                    } else {
                        startExhalePhase();
                    }
                }, duration * 1000);
            }

            function startHoldPhase() {
                if (!exerciseActive || exercisePaused) return;

                currentPhase = 'hold';
                const duration = currentPattern.hold;

                // Update UI
                breathingAction.textContent = 'Hold';
                updateCountdown(duration);

                // Add hold class
                breathingCircle.classList.remove('inhale', 'exhale');
                breathingCircle.classList.add('hold');

                // When hold is done, move to exhale
                setTimeout(() => {
                    if (!exerciseActive || exercisePaused) return;
                    startExhalePhase();
                }, duration * 1000);
            }

            function startExhalePhase() {
                if (!exerciseActive || exercisePaused) return;

                currentPhase = 'exhale';
                const duration = currentPattern.exhale;

                // Update UI
                breathingAction.textContent = 'Exhale';
                updateCountdown(duration);

                // Animation
                breathingCircle.style.transform = 'scale(1)';
                breathingAnimation.style.transform = 'scale(0.8)';
                breathingAnimationShadow.style.transform = 'scale(0.85)';

                // Add exhale class and remove other classes
                breathingCircle.classList.remove('inhale', 'hold');

                // Set animation duration dynamically based on the exhale duration
                wave.style.animationDuration = `${duration}s`;
                wave.style.animationFillMode = 'forwards';

                // Apply the exhale class after setting the animation duration
                breathingCircle.classList.add('exhale');

                // When exhale is done, start next cycle or complete
                setTimeout(() => {
                    if (!exerciseActive || exercisePaused) return;

                    // Update progress bar
                    const progress = (currentCycle / currentPattern.cycles) * 100;
                    progressFill.style.width = `${progress}%`;

                    if (currentCycle < currentPattern.cycles) {
                        currentCycle++;
                        updateCurrentCycleDisplay();
                        startInhalePhase();
                    } else {
                        completeExercise();
                    }
                }, duration * 1000);
            }

            function updateCountdown(duration) {
                let timeLeft = duration;
                breathingCounter.textContent = timeLeft.toFixed(1);

                clearInterval(intervalId);
                intervalId = setInterval(() => {
                    if (exercisePaused) {
                        clearInterval(intervalId);
                        return;
                    }

                    timeLeft -= 0.1;
                    if (timeLeft <= 0) {
                        clearInterval(intervalId);
                        breathingCounter.textContent = '0';
                    } else {
                        breathingCounter.textContent = timeLeft.toFixed(1);
                    }
                }, 100);
            }

            function updateCurrentCycleDisplay() {
                currentCycleDisplay.textContent = `Cycle ${currentCycle}/${currentPattern.cycles}`;
            }

            function updateTimer() {
                if (!exerciseActive) return;

                const elapsed = Date.now() - startTime - elapsedPausedTime;
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor(elapsed / 1000 / 60);

                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Update progress
                if (totalDuration > 0) {
                    const progress = Math.min((elapsed / (totalDuration * 1000)) * 100, 100);
                    progressFill.style.width = `${progress}%`;
                }

                requestAnimationFrame(updateTimer);
            }

            function completeExercise() {
                stopExercise();
                showCompleteView();
            }

            function resetExerciseState() {
                currentCycle = 0;
                currentPhase = null;
                exerciseActive = false;
                exercisePaused = false;
                elapsedPausedTime = 0;
                startTime = null;

                clearInterval(intervalId);
                clearInterval(countdownId);

                startButton.style.display = 'flex';
                pauseButton.style.display = 'none';
                resumeButton.style.display = 'none';
                stopButton.style.display = 'none';

                // Reset UI
                breathingAction.textContent = 'Prepare...';
                breathingCounter.textContent = '3';
                breathingCounter.style.display = 'block';
                progressFill.style.width = '0%';
                currentCycleDisplay.textContent = 'Cycle 0/5';
                timerDisplay.textContent = '00:00';

                resetAnimations();
            }

            function resetAnimations() {
                if (breathingCircle) {
                    breathingCircle.style.transform = '';
                    breathingCircle.classList.remove('inhale', 'hold', 'exhale');
                }
                if (breathingAnimation) {
                    breathingAnimation.style.transform = '';
                }
                if (breathingAnimationShadow) {
                    breathingAnimationShadow.style.transform = '';
                }
                if (wave) {
                    wave.style.transform = '';
                    wave.style.animationDuration = '';
                    wave.style.animationFillMode = '';
                }
                if (progressFill) {
                    progressFill.style.width = '0%';
                }
            }

            function calculateTotalDuration() {
                const cycleTime = currentPattern.inhale + currentPattern.hold + currentPattern.exhale;
                return currentPattern.cycles * cycleTime;
            }

            // Initial state
            showSelectionView();
        });
    </script>

    <script>
        // CBT Modal Functionality
        document.addEventListener('DOMContentLoaded', function () {
            const cbtButton = document.getElementById('cbt-button');
            const cbtModal = document.getElementById('cbt-modal');
            const closeCbtModal = document.getElementById('close-cbt-modal');

            // Open modal
            cbtButton.addEventListener('click', () => {
                cbtModal.style.display = 'flex';
                showWorksheetSelection();
            });

            // Close modal
            closeCbtModal.addEventListener('click', () => {
                cbtModal.style.display = 'none';
            });

            // Worksheet selection
            const worksheetSelection = document.getElementById('worksheet-selection');
            const worksheets = document.querySelectorAll('.cbt-section');
            const worksheetOptions = document.querySelectorAll('.worksheet-option');

            // Handle worksheet selection
            worksheetOptions.forEach(option => {
                const startBtn = option.querySelector('.start-btn');
                startBtn.addEventListener('click', () => {
                    const worksheetId = option.getAttribute('data-worksheet');
                    worksheetSelection.style.display = 'none';
                    worksheets.forEach(section => section.style.display = 'none');
                    document.getElementById(`${worksheetId}-section`).style.display = 'block';
                });
            });

            // Back to worksheet selection
            const backToSelection = document.querySelectorAll('.back-to-selection');
            backToSelection.forEach(button => {
                button.addEventListener('click', () => {
                    showWorksheetSelection();
                });
            });

            // Initial setup - hide all worksheets, show selection screen
            function showWorksheetSelection() {
                worksheetSelection.style.display = 'flex';
                worksheets.forEach(section => section.style.display = 'none');
            }

            // When opening modal, always show selection screen first
            showWorksheetSelection();

            // ============== THOUGHT RECORD FUNCTIONALITY ==============
            const thoughtRecordForm = document.querySelector('.thought-record-form');
            const saveThoughtRecordBtn = document.getElementById('save-thought-record');
            const thoughtRecordsContainer = document.getElementById('thought-records-container');
            const thoughtRecords = JSON.parse(localStorage.getItem('thoughtRecords') || '[]');

            // Display existing thought records
            function displayThoughtRecords() {
                if (thoughtRecords.length === 0) {
                    thoughtRecordsContainer.innerHTML = `
                        <div class="empty-state">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                            </svg>
                            <p>You haven't created any thought records yet</p>
                            <button class="cbt-btn">Create Your First Record</button>
                        </div>
                    `;

                    // Add event listener to the "Create Your First Record" button
                    const createFirstRecordBtn = thoughtRecordsContainer.querySelector('.cbt-btn');
                    if (createFirstRecordBtn) {
                        createFirstRecordBtn.addEventListener('click', () => {
                            // Scroll to the form
                            thoughtRecordForm.scrollIntoView({ behavior: 'smooth' });
                        });
                    }
                    return;
                }

                thoughtRecordsContainer.innerHTML = '';
                thoughtRecords.forEach((record, index) => {
                    const recordItem = document.createElement('div');
                    recordItem.className = 'thought-record-item';
                    recordItem.innerHTML = `
                        <div class="thought-record-header">
                            <h4>Thought Record #${index + 1}</h4>
                            <span class="thought-record-date">${new Date(record.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="thought-record-detail"><strong>Situation:</strong> ${record.situation}</div>
                        <div class="thought-record-detail"><strong>Thought:</strong> ${record.automaticThought}</div>
                        <div class="thought-record-detail"><strong>Emotions:</strong> ${record.emotions}</div>
                        <div class="thought-record-detail"><strong>Evidence For:</strong> ${record.evidenceFor}</div>
                        <div class="thought-record-detail"><strong>Evidence Against:</strong> ${record.evidenceAgainst}</div>
                        <div class="thought-record-detail"><strong>Balanced Thought:</strong> ${record.balancedThought}</div>
                        <button class="cbt-btn delete-record" data-index="${index}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete
                        </button>
                    `;
                    thoughtRecordsContainer.appendChild(recordItem);

                    // Add event listener to delete button
                    const deleteBtn = recordItem.querySelector('.delete-record');
                    deleteBtn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        thoughtRecords.splice(index, 1);
                        localStorage.setItem('thoughtRecords', JSON.stringify(thoughtRecords));
                        displayThoughtRecords();
                    });
                });
            }

            // Save thought record
            saveThoughtRecordBtn.addEventListener('click', () => {
                const situation = document.getElementById('situation').value.trim();
                const automaticThought = document.getElementById('automatic-thought').value.trim();
                const emotions = document.getElementById('emotions').value.trim();
                const evidenceFor = document.getElementById('evidence-for').value.trim();
                const evidenceAgainst = document.getElementById('evidence-against').value.trim();
                const balancedThought = document.getElementById('balanced-thought').value.trim();

                if (!situation || !automaticThought) {
                    alert('Please fill in at least the Situation and Automatic Thought fields.');
                    return;
                }

                const thoughtRecord = {
                    situation,
                    automaticThought,
                    emotions,
                    evidenceFor,
                    evidenceAgainst,
                    balancedThought,
                    timestamp: new Date().toISOString()
                };

                thoughtRecords.unshift(thoughtRecord); // Add to beginning of array
                localStorage.setItem('thoughtRecords', JSON.stringify(thoughtRecords));

                // Clear form
                document.getElementById('situation').value = '';
                document.getElementById('automatic-thought').value = '';
                document.getElementById('emotions').value = '';
                document.getElementById('evidence-for').value = '';
                document.getElementById('evidence-against').value = '';
                document.getElementById('balanced-thought').value = '';

                displayThoughtRecords();
            });

            // Initialize thought records display
            displayThoughtRecords();

            // ============== WORRY TIME FUNCTIONALITY ==============
            const addWorryBtn = document.getElementById('add-worry');
            const addSolutionBtn = document.getElementById('add-solution');
            const worriesContainer = document.getElementById('worries-container');
            const solutionsContainer = document.getElementById('solutions-container');

            // Timer elements
            const timerOptions = document.querySelectorAll('.timer-option');
            const timerProgress = document.querySelector('.timer-progress');
            const timerTime = document.querySelector('.timer-time');
            const timerLabel = document.querySelector('.timer-label');
            const startTimerBtn = document.getElementById('start-worry-timer');
            const stopTimerBtn = document.getElementById('stop-worry-timer');
            const timerMarkers = document.querySelector('.timer-markers');

            const worries = JSON.parse(localStorage.getItem('worries') || '[]');
            const solutions = JSON.parse(localStorage.getItem('solutions') || '[]');

            // Timer variables
            let selectedDuration = 0;
            let timerInterval = null;
            let startTime = null;
            let remainingTime = 0;
            let timerRunning = false;

            // Create timer markers (60 dots around the circle)
            for (let i = 0; i < 60; i++) {
                const marker = document.createElement('div');
                marker.className = 'timer-marker';
                marker.style.transform = `rotate(${i * 6}deg) translate(97px)`;
                timerMarkers.appendChild(marker);
            }

            // Timer option selection
            timerOptions.forEach(option => {
                option.addEventListener('click', () => {
                    if (timerRunning) return; // Don't allow changing while timer is running

                    // Remove active class from all options
                    timerOptions.forEach(opt => opt.classList.remove('active'));

                    // Add active class to selected option
                    option.classList.add('active');

                    // Get duration from data attribute
                    selectedDuration = parseInt(option.getAttribute('data-duration'));

                    // Update timer display
                    const minutes = Math.floor(selectedDuration);
                    const seconds = 0;
                    timerTime.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    timerLabel.textContent = `${selectedDuration} minutes`;

                    // Set initial timer position based on duration
                    let startPosition = 0;
                    if (selectedDuration === 15) startPosition = 25; // Start from 3 o'clock (25%)
                    else if (selectedDuration === 30) startPosition = 50; // Start from 6 o'clock (50%)
                    else if (selectedDuration === 45) startPosition = 75; // Start from 9 o'clock (75%)
                    else if (selectedDuration === 60) startPosition = 0; // Start from 12 o'clock (0%)

                    timerProgress.style.background = `conic-gradient(var(--accent) ${startPosition}%, transparent ${startPosition}%)`;
                });
            });

            // Start timer
            startTimerBtn.addEventListener('click', () => {
                if (selectedDuration === 0) {
                    alert('Please select a duration first');
                    return;
                }

                startTimer();
            });

            // Stop timer
            stopTimerBtn.addEventListener('click', () => {
                stopTimer();

                // Save progress to localStorage
                const completedPercentage = ((selectedDuration * 60) - remainingTime) / (selectedDuration * 60) * 100;
                const worrySession = {
                    duration: selectedDuration,
                    completedPercentage: Math.round(completedPercentage),
                    timestamp: new Date().toISOString()
                };

                const worrySessions = JSON.parse(localStorage.getItem('worrySessions') || '[]');
                worrySessions.push(worrySession);
                localStorage.setItem('worrySessions', JSON.stringify(worrySessions));

                // Save worry list and solutions if present
                const currentWorries = [];
                const currentSolutions = [];

                // Get all worries from the worries container
                const worryItems = worriesContainer.querySelectorAll('.worry-item');
                worryItems.forEach(item => {
                    const worryText = item.querySelector('.worry-text').textContent;
                    currentWorries.push(worryText);
                });

                // Get all solutions from the solutions container
                const solutionItems = solutionsContainer.querySelectorAll('.solution-item');
                solutionItems.forEach(item => {
                    const solutionText = item.querySelector('.solution-text').textContent;
                    currentSolutions.push(solutionText);
                });

                // Save to localStorage only if items exist
                if (currentWorries.length > 0) {
                    localStorage.setItem('worries', JSON.stringify(currentWorries));
                }

                if (currentSolutions.length > 0) {
                    localStorage.setItem('solutions', JSON.stringify(currentSolutions));
                }

                // Show success message
                alert(`Worry session saved! You completed ${Math.round(completedPercentage)}% of your scheduled worry time.`);

                resetTimer();
            });

            function startTimer() {
                if (timerRunning) return;

                timerRunning = true;
                startTime = Date.now();
                remainingTime = selectedDuration * 60; // Convert to seconds

                // Update UI
                startTimerBtn.style.display = 'none';
                stopTimerBtn.style.display = 'flex';
                timerOptions.forEach(opt => opt.style.pointerEvents = 'none');

                // Add pulsing animation to timer display
                document.querySelector('.timer-display').style.animation = 'pulse 2s infinite';

                // Set initial timer position based on duration
                let startPosition = 0;
                if (selectedDuration === 15) startPosition = 25; // Start from 3 o'clock (25%)
                else if (selectedDuration === 30) startPosition = 50; // Start from 6 o'clock (50%)
                else if (selectedDuration === 45) startPosition = 75; // Start from 9 o'clock (75%)
                else if (selectedDuration === 60) startPosition = 0; // Start from 12 o'clock (0%)

                timerInterval = setInterval(() => {
                    // Calculate remaining time
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    remainingTime = (selectedDuration * 60) - elapsed;

                    if (remainingTime <= 0) {
                        // Timer complete
                        clearInterval(timerInterval);
                        timerRunning = false;
                        remainingTime = 0;

                        // Update UI
                        timerTime.textContent = '00:00';
                        timerLabel.textContent = 'Time complete!';
                        timerProgress.style.background = 'conic-gradient(var(--accent) 100%, transparent 0%)';

                        // Reset UI after delay
                        setTimeout(resetTimer, 3000);

                        return;
                    }

                    // Update timer display
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    timerTime.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    // Calculate and update progress
                    const progress = (1 - (remainingTime / (selectedDuration * 60))) * 100;
                    const currentPosition = (startPosition + progress) % 100;
                    timerProgress.style.background = `conic-gradient(var(--accent) ${currentPosition}%, transparent ${currentPosition}%)`;

                }, 1000);
            }

            function stopTimer() {
                if (!timerRunning) return;

                clearInterval(timerInterval);
                timerRunning = false;
            }

            function resetTimer() {
                // Reset UI
                stopTimer();
                startTimerBtn.style.display = 'flex';
                stopTimerBtn.style.display = 'none';
                timerOptions.forEach(opt => opt.style.pointerEvents = 'auto');
                timerOptions.forEach(opt => opt.classList.remove('active'));
                timerTime.textContent = '00:00';
                timerLabel.textContent = 'Select duration';
                timerProgress.style.background = 'conic-gradient(var(--accent) 0%, transparent 0%)';
                selectedDuration = 0;

                // Remove pulsing animation
                document.querySelector('.timer-display').style.animation = '';
            }

            // Display worries
            function displayWorries() {
                worriesContainer.innerHTML = '';

                if (worries.length === 0) {
                    worriesContainer.innerHTML = '<div class="empty-state-mini">No worries added yet</div>';
                    return;
                }

                worries.forEach((worry, index) => {
                    const worryItem = document.createElement('div');
                    worryItem.className = 'worry-item';
                    worryItem.innerHTML = `
                        <div class="worry-text">${worry.text}</div>
                        <div class="worry-time">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Added ${new Date(worry.timestamp).toLocaleDateString()}
                        </div>
                        <button class="worry-remove" data-index="${index}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;
                    worriesContainer.appendChild(worryItem);

                    // Add event listener to remove button
                    const removeBtn = worryItem.querySelector('.worry-remove');
                    removeBtn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        worries.splice(index, 1);
                        localStorage.setItem('worries', JSON.stringify(worries));
                        displayWorries();
                    });
                });
            }

            // Display solutions
            function displaySolutions() {
                solutionsContainer.innerHTML = '';

                if (solutions.length === 0) {
                    solutionsContainer.innerHTML = '<div class="empty-state-mini">No solutions added yet</div>';
                    return;
                }

                solutions.forEach((solution, index) => {
                    const solutionItem = document.createElement('div');
                    solutionItem.className = 'solution-item';
                    solutionItem.innerHTML = `
                        <div class="solution-text">${solution.text}</div>
                        <div class="solution-priority">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Added ${new Date(solution.timestamp).toLocaleDateString()}
                        </div>
                        <button class="solution-remove" data-index="${index}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;

                    solutionsContainer.appendChild(solutionItem);

                    // Add event listener to remove button
                    const removeBtn = solutionItem.querySelector('.solution-remove');
                    removeBtn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        solutions.splice(index, 1);
                        localStorage.setItem('solutions', JSON.stringify(solutions));
                        displaySolutions();
                    });
                });
            }

            // Add worry
            addWorryBtn.addEventListener('click', () => {
                const worryText = document.getElementById('new-worry').value.trim();

                if (!worryText) {
                    alert('Please enter a worry.');
                    return;
                }

                const worry = {
                    text: worryText,
                    timestamp: new Date().toISOString()
                };

                worries.unshift(worry); // Add to beginning of array
                localStorage.setItem('worries', JSON.stringify(worries));

                // Clear input
                document.getElementById('new-worry').value = '';

                displayWorries();
            });

            // Add solution
            addSolutionBtn.addEventListener('click', () => {
                const solutionText = document.getElementById('new-solution').value.trim();

                if (!solutionText) {
                    alert('Please enter a solution or action step.');
                    return;
                }

                const solution = {
                    text: solutionText,
                    timestamp: new Date().toISOString()
                };

                solutions.unshift(solution); // Add to beginning of array
                localStorage.setItem('solutions', JSON.stringify(solutions));

                // Clear input
                document.getElementById('new-solution').value = '';

                displaySolutions();
            });

            // Initialize worry time
            displayWorries();
            displaySolutions();

            // Check if it's worry time
            function checkWorryTime() {
                if (!worryTime) return;

                const now = new Date();
                const [hours, minutes] = worryTime.split(':');
                const worryTimeDate = new Date();
                worryTimeDate.setHours(parseInt(hours));
                worryTimeDate.setMinutes(parseInt(minutes));
                worryTimeDate.setSeconds(0);

                const timeDiff = Math.abs(now - worryTimeDate);

                // If it's within 5 minutes of worry time, show a notification
                if (timeDiff <= 5 * 60 * 1000) {
                    // Check if we've already shown a notification today
                    const lastNotification = localStorage.getItem('lastWorryTimeNotification');
                    const today = new Date().toDateString();

                    if (lastNotification !== today) {
                        if (Notification.permission === "granted") {
                            const notification = new Notification("It's Worry Time", {
                                body: `Time to address your worries for ${worryDuration} minutes.`,
                                icon: "/favicon.ico"
                            });

                            notification.onclick = function () {
                                window.focus();
                                cbtModal.style.display = 'flex';
                                document.querySelector('[data-tab="worry-time"]').click();
                            };

                            localStorage.setItem('lastWorryTimeNotification', today);
                        } else if (Notification.permission !== "denied") {
                            Notification.requestPermission();
                        }
                    }
                }
            }

            // Request notification permission
            if ("Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }

            // Check for worry time every minute
            setInterval(checkWorryTime, 60 * 1000);
            checkWorryTime(); // Check immediately on load

            // Add keyboard shortcuts for text areas
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();

                        // Find the closest button and click it
                        const form = this.closest('.form-group').parentNode;
                        const button = form.querySelector('button');
                        if (button) {
                            button.click();
                        }
                    }
                });
            });
        });
    </script>

    <script>
        // Mood tracking functionality
        function initMoodTracker(userId) {
            console.log('Initializing mood tracker with userId:', userId);

            // Get all mood options
            const moodOptions = document.querySelectorAll('.mood-option');

            // Add click event to each mood option
            moodOptions.forEach(option => {
                option.addEventListener('click', function () {
                    const mood = this.getAttribute('data-mood');
                    console.log('Mood clicked:', mood, 'for user:', userId);

                    // Save the mood
                    saveMood(userId, mood);

                    // Add active class to selected mood and remove from others
                    moodOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            console.log('Fetching initial mood history for user:', userId);
            // Fetch mood history on page load
            fetchMoodHistory(userId);
        }

        /**
         * Save the user's mood to the backend
         * @param {string} userId - The user ID
         * @param {string} mood - The selected mood
         */
        function saveMood(userId, mood) {
            try {
                console.log('Saving mood:', mood, 'for user:', userId);

                // Ensure correct structure of payload
                const payload = {
                    userId: userId,
                    mood: mood
                };

                console.log('Payload:', payload);

                fetch(CONFIG.apiEndpoints.mood.save, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Mood saved successfully');
                            // Refresh mood history
                            fetchMoodHistory(userId);
                        } else {
                            console.error('Error saving mood:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error processing mood save response:', error);
                    });
            } catch (error) {
                console.error('Error saving mood:', error);
            }
        }

        /**
         * Fetch the user's mood history from the backend
         * @param {string} userId - The user ID
         */
        function fetchMoodHistory(userId) {
            try {
                console.log('Fetching mood history for user:', userId);

                if (!userId) {
                    console.error('No userId provided to fetchMoodHistory');
                    userId = getConsistentUserId();
                    console.log('Using consistent userId instead:', userId);
                }

                // Create URL with properly encoded userId query parameter
                const url = `${CONFIG.apiEndpoints.mood.history}?userId=${encodeURIComponent(userId)}`;
                console.log('Mood history API URL:', url);

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        console.log('Mood history response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Mood history response data:', data);

                        // Check various data structures that might be returned
                        let moodEntries = [];
                        if (data.status === 'success' && data.data && Array.isArray(data.data)) {
                            moodEntries = data.data;
                        } else if (Array.isArray(data)) {
                            moodEntries = data;
                        }

                        console.log('Processed mood entries:', moodEntries);

                        if (moodEntries.length > 0) {
                            // Display mood history
                            displayMoodHistory(moodEntries);

                            // Show the mood history container
                            const historyContainer = document.getElementById('mood-history-container');
                            if (historyContainer) {
                                historyContainer.style.display = 'block';
                                console.log('Displaying mood history container');
                            } else {
                                console.error('Mood history container element not found');
                            }
                        } else {
                            console.log('No mood history found or empty response');
                            // Hide the mood history container on error
                            const historyContainer = document.getElementById('mood-history-container');
                            if (historyContainer) {
                                historyContainer.style.display = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error processing mood history response:', error);
                        // Hide the mood history container on error
                        const historyContainer = document.getElementById('mood-history-container');
                        if (historyContainer) {
                            historyContainer.style.display = 'none';
                        }
                    });
            } catch (error) {
                console.error('Error fetching mood history:', error);
                // Hide the mood history container on error
                const historyContainer = document.getElementById('mood-history-container');
                if (historyContainer) {
                    historyContainer.style.display = 'none';
                }
            }
        }

        /**
         * Display the mood history in the UI
         * @param {Array} moodHistory - Array of mood history entries
         */
        function displayMoodHistory(moodHistory) {
            const historyContainer = document.getElementById('mood-history');
            historyContainer.innerHTML = '';

            // Create elements for each mood entry
            moodHistory.forEach((entry, index) => {
                const moodDay = document.createElement('div');
                moodDay.className = 'mood-day';

                const moodEmoji = document.createElement('div');
                moodEmoji.className = 'mood-day-emoji';
                moodEmoji.textContent = getMoodEmoji(entry.mood);

                const moodLabel = document.createElement('div');
                moodLabel.className = 'mood-day-label';
                moodLabel.textContent = getDayName(new Date(entry.timestamp));

                moodDay.appendChild(moodEmoji);
                moodDay.appendChild(moodLabel);

                historyContainer.appendChild(moodDay);
            });
        }

        /**
         * Get the emoji for a given mood
         * @param {string} mood - The mood
         * @returns {string} - The corresponding emoji
         */
        function getMoodEmoji(mood) {
            const emojiMap = {
                'Great': '😊',
                'Good': '😀',
                'Okay': '😐',
                'Down': '😔',
                'Stressed': '😓',
                'Angry': '😠'
            };

            return emojiMap[mood] || '😐';
        }

        /**
         * Get the day name (DD/MM) for a given date
         * @param {Date} date - The date
         * @returns {string} - The day name abbreviation
         */
        function getDayName(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}/${month}`;
        }
    </script>

    <script>
        // Add a window.onload event to ensure all resources are loaded
        window.onload = function () {
            console.log('Window fully loaded - direct call to fetch mood history');
            const userId = getConsistentUserId();
            console.log('Using userId for direct mood history fetch:', userId);

            // Direct call to the API
            try {
                const url = `${CONFIG.apiEndpoints.mood.history}?userId=${encodeURIComponent(userId)}`;
                console.log('Direct mood history call to URL:', url);

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        console.log('Direct mood history response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Direct mood history response data:', data);
                        if (data.status === 'success' && data.data && data.data.length > 0) {
                            // Display mood history
                            displayMoodHistory(data.data);

                            // Show the mood history container
                            const historyContainer = document.getElementById('mood-history-container');
                            if (historyContainer) {
                                historyContainer.style.display = 'block';
                            }
                        } else {
                            console.log('No mood history found in direct call');
                        }
                    })
                    .catch(error => {
                        console.error('Error in direct mood history call:', error);
                    });
            } catch (error) {
                console.error('Exception in direct mood history call:', error);
            }
        };
    </script>
</body>

</html>